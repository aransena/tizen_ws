<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no">
		<title>Hello TAU</title>
		<link rel="stylesheet" href="lib/tau/wearable/theme/default/tau.css"/>
		<link rel="stylesheet" media="all" href="lib/tau/wearable/theme/default/tau.circle.min.css">
		<!--load theme file for your application-->
		<link rel="stylesheet"href="css/style.css"/>
	</head>
	<body>
	
	<div class="ui-page ui-page-active" id="robotControl">
	   <div class="ui-content" style="position:absolute;">
	   		<canvas id="canvas" width="360" height="360" style="position:relative; top:-100px;letter-spacing: 0px;z-index:2"></canvas>
	   
	   </div>
   <!--  <footer class="ui-footer ui-bottom-button">
      <a href="" class="ui-btn" id="btn-Send">Send</a>
   </footer>-->
	  
	<script>
	var ws='';
	var url= window.localStorage.getItem('url').toString();	
	console.log("connecting to: "+url);  		  
	ws = new WebSocket(url);
	
	/*var ev = document.getElementById("btn-Send");
	ev.addEventListener("click", function ()
	{
		if(ws.readyState==1){
			ws.send("Hello");
			console.log("Button Press");
		}
	});*/
	

	////////// Websocket related functions /////////
	ws.onopen = function() {
		ws.send('Ping'); // Send the message 'Ping' to the server
	};
	ws.onclose = function() {
		
	};
	ws.onmessage = function(msg) {
		console.log(msg); // Send the message 'Ping' to the server
	};
	ws.onerror = function () {
		console.error("Websocket Error!");
	};
	///////////////////////////////////////////////
	
	
	//////////////////Events//////////////////////
	var page = document.getElementById("robotControl");
	
	// Rotary Events //
    var rotaryEventHandler = function(e)
    {
        
        var ev_time=tizen.time.getCurrentDateTime().getSeconds()+"."+tizen.time.getCurrentDateTime().getMilliseconds();
       if (e.detail.direction === "CW")
       {
    	   console.log("Rotate CW:\t'"+ ev_time);
    	   ws.send("CW\t"+ev_time);
    	   
       }
       else if (e.detail.direction === "CCW") 
       {
    	   console.log("Rotate CCW:\t"+tizen.time.getCurrentDateTime().getMilliseconds());
    	   ws.send("CCW\t"+ev_time);
    	   
       }
        
    };

	window.addEventListener("rotarydetent", rotaryEventHandler);	
	
	
	////// Touch Events //////
	
	// Screen Touch Events//
    /*page.addEventListener("click", function(){
		if(ws.readyState==1){
			ws.send("Screen Press");
			console.log("Screen Press");
		}
	});*/

	// Multitouch Events //
    var multiTouchHandler = function(e){
		e.preventDefault();	
        touchOn = tizen.time.getCurrentDateTime().getSeconds();
    	if(ws.readyState==1){
			
			var touchCount = e.touches.length;
			console.log("touches: " + touchCount);
			ws.send("Touches: " + touchCount);
			
			switch(e.touches.length){
			case 2:
	    		console.log("2 finger press");
	    		ws.send("Two Finger Press");
	    		document.getElementById("canvas").style.backgroundColor = "blue";
				break;
			case 1:
	    		console.log("1 finger press");
	    		ws.send("One Finger Press");
	    		document.getElementById("canvas").style.backgroundColor = "red";
    	
				break;
	
			default:
	    		console.log("Error");
	    		ws.send("Unknown");
				break;
			}
    	}
    	else{
        	console.log("Websocket not ready for touch event");
        	}
    }

    // TODO watchdog callback to check connection is okay - but websocket error function should handle this....
    var watchdogTouchHandler = function(e){
    	if(ws.readyState==1){

    	}
    	else{
        	console.log("Websocket not ready for touch event");
      	}
    }
    
    var endTouchHandler = function(e){
    	if(ws.readyState==1){
        	ws.send("End Touch");
        	console.log("End Touch");
    		document.getElementById("canvas").style.backgroundColor = "black";
      	}
    	else{
        	console.log("Websocket not ready for touch event");
        	}
    }
    
    page.addEventListener('touchstart', multiTouchHandler, false);
//    document.addEventListener('touchmove', watchdogTouchHandler, false);
    page.addEventListener('touchend', endTouchHandler, false);

	// HW Back Button Press Event - modified from app.js to unregister rotary handler from window //
    window.addEventListener( 'tizenhwkey', function( ev ) {
		if( ev.keyName === "back" ) {
			window.removeEventListener("rotarydetent", rotaryEventHandler);	
			var page = document.getElementsByClassName( 'ui-page-active' )[0],
				pageid = page ? page.id : "";
			
			if( pageid === "pageMain" ) {
				try {
					tizen.application.getCurrentApplication().exit();
				} catch (ignore) {
				}
			} else {
				window.history.back();
			}
		}
	} );
	/////////////////////////////////////////////////////////
	
   </script>
   
   
	</div>
	<!-- <script src="app.js"></script> -->
	
	</body>
</html>